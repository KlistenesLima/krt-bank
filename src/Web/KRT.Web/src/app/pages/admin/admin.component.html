<div class="command-center" [class.collapsed]="sidebarCollapsed">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo" *ngIf="!sidebarCollapsed">
        <span class="logo-icon">&#9670;</span>
        <span class="logo-text">KRT</span>
        <span class="logo-sub">COMMAND</span>
      </div>
      <button class="collapse-btn" (click)="sidebarCollapsed = !sidebarCollapsed">
        {{ sidebarCollapsed ? '&#9654;' : '&#9664;' }}
      </button>
    </div>

    <nav class="sidebar-nav">
      <button [class.active]="activeSection === 'dashboard'" (click)="setSection('dashboard')">
        <mat-icon class="nav-icon">dashboard</mat-icon>
        <span class="nav-label" *ngIf="!sidebarCollapsed">Dashboard</span>
      </button>
      <button [class.active]="activeSection === 'transactions'" (click)="setSection('transactions')">
        <mat-icon class="nav-icon">receipt_long</mat-icon>
        <span class="nav-label" *ngIf="!sidebarCollapsed">Transações</span>
      </button>
      <button [class.active]="activeSection === 'accounts'" (click)="setSection('accounts')">
        <mat-icon class="nav-icon">people</mat-icon>
        <span class="nav-label" *ngIf="!sidebarCollapsed">Contas</span>
      </button>
      <button [class.active]="activeSection === 'fraud'" (click)="setSection('fraud')">
        <mat-icon class="nav-icon">shield</mat-icon>
        <span class="nav-label" *ngIf="!sidebarCollapsed">Fraude</span>
        <span class="nav-badge" *ngIf="!sidebarCollapsed && fraudAlerts.length">{{ fraudAlerts.length }}</span>
      </button>
      <button [class.active]="activeSection === 'system'" (click)="setSection('system')">
        <mat-icon class="nav-icon">settings</mat-icon>
        <span class="nav-label" *ngIf="!sidebarCollapsed">Sistema</span>
      </button>
    </nav>

    <div class="sidebar-footer" *ngIf="!sidebarCollapsed">
      <button class="back-btn" (click)="logout()">&#8592; Voltar ao App</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <!-- TOP BAR -->
    <header class="topbar">
      <div class="topbar-left">
        <h1>{{ activeSection === 'dashboard' ? 'Command Center' : activeSection === 'transactions' ? 'Monitor de Transações' : activeSection === 'accounts' ? 'Gestão de Contas' : activeSection === 'fraud' ? 'Central de Fraude' : 'Status do Sistema' }}</h1>
      </div>
      <div class="topbar-right">
        <span class="live-indicator">
          <span class="pulse-dot"></span> LIVE
        </span>
        <span class="clock">{{ currentTime }}</span>
        <div class="admin-avatar">AD</div>
      </div>
    </header>

    <!-- LOADING -->
    <div class="loading-state" *ngIf="loading">
      <div class="spinner"></div>
      <span>Carregando dados...</span>
    </div>

    <!-- ERROR STATE -->
    <div class="error-state" *ngIf="!loading && loadError && !dashboard">
      <mat-icon style="font-size:48px;width:48px;height:48px;color:#f59e0b;margin-bottom:16px;">warning</mat-icon>
      <h2 style="color:#f1f5f9;font-size:1.3rem;margin:0 0 8px;">Falha ao carregar dados</h2>
      <p style="color:#94a3b8;font-size:0.9rem;margin:0 0 20px;">Nao foi possivel conectar ao servidor. Verifique se os servicos estao rodando.</p>
      <button style="background:#0047BB;color:#fff;border:none;padding:12px 28px;border-radius:10px;font-size:0.9rem;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;" (click)="loadAll()">
        Tentar novamente
      </button>
    </div>

    <!-- ========== DASHBOARD ========== -->
    <div class="content-area" *ngIf="!loading && activeSection === 'dashboard' && dashboard">
      <!-- KPI CARDS -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-header">
            <span class="kpi-label">Contas Ativas</span>
            <span class="kpi-trend up">&#8593; 12%</span>
          </div>
          <div class="kpi-value">{{ dashboard.overview.activeAccounts | number }}</div>
          <div class="kpi-sub">de {{ dashboard.overview.totalAccounts | number }} totais</div>
        </div>
        <div class="kpi-card accent-blue">
          <div class="kpi-header">
            <span class="kpi-label">Transações Hoje</span>
            <span class="kpi-trend up">&#8593; 8%</span>
          </div>
          <div class="kpi-value">{{ dashboard.transactions.today | number }}</div>
          <div class="kpi-sub">Ticket médio: R$ {{ dashboard.transactions.avgTicket | number:'1.0-0' }}</div>
        </div>
        <div class="kpi-card accent-green">
          <div class="kpi-header">
            <span class="kpi-label">Volume Total</span>
            <span class="kpi-trend up">&#8593; 15%</span>
          </div>
          <div class="kpi-value">R$ {{ getTotalVolume() }}</div>
          <div class="kpi-sub">{{ dashboard.transactions.thisMonth | number }} este mês</div>
        </div>
        <div class="kpi-card accent-red">
          <div class="kpi-header">
            <span class="kpi-label">Alertas Fraude</span>
            <span class="kpi-trend down">{{ dashboard.fraud.alertsToday }}</span>
          </div>
          <div class="kpi-value">{{ dashboard.fraud.blockedToday }} bloq.</div>
          <div class="kpi-sub">R$ {{ dashboard.fraud.totalFraudPrevented | number:'1.0-0' }} evitados</div>
        </div>
      </div>

      <!-- CHARTS ROW: Line + Donut -->
      <div class="charts-row">
        <div class="chart-card chart-large">
          <div class="chart-header">
            <h3>Volume de Transações</h3>
            <span class="chart-period">Últimos 14 dias</span>
          </div>
          <div class="chart-canvas-wrapper">
            <canvas id="chartTransactions"></canvas>
          </div>
        </div>
        <div class="chart-card chart-small">
          <div class="chart-header">
            <h3>Receita por Método</h3>
          </div>
          <div class="chart-canvas-wrapper donut-wrapper">
            <canvas id="chartRevenue"></canvas>
          </div>
        </div>
      </div>

      <!-- ACTIVITY FEED -->
      <div class="charts-row">
        <div class="chart-card full-width feed-card">
          <div class="chart-header">
            <h3>Atividade em Tempo Real</h3>
            <span class="chart-period live-text">&#9679; Live</span>
          </div>
          <div class="activity-feed">
            <div class="feed-item" *ngFor="let item of activityFeed">
              <span class="feed-dot" [style.background]="item.color"></span>
              <span class="feed-text">{{ item.text }} <small class="feed-detail" *ngIf="item.detail">— {{ item.detail }}</small></span>
              <span class="feed-time">{{ item.timeFormatted }}</span>
            </div>
            <div class="feed-empty" *ngIf="activityFeed.length === 0">
              Aguardando atividade...
            </div>
          </div>
        </div>
      </div>

      <!-- SYSTEM HEALTH ROW -->
      <div class="charts-row">
        <div class="chart-card full-width">
          <div class="chart-header"><h3>Saúde do Sistema</h3></div>
          <div class="health-grid">
            <div class="health-item">
              <span class="health-dot green"></span>
              <span class="health-label">API Gateway</span>
              <span class="health-val">{{ dashboard.systemHealth.apiLatency }}</span>
            </div>
            <div class="health-item">
              <span class="health-dot green"></span>
              <span class="health-label">Uptime</span>
              <span class="health-val">{{ dashboard.systemHealth.uptime }}</span>
            </div>
            <div class="health-item">
              <span class="health-dot" [class.green]="dashboard.systemHealth.errorRate &lt; '1%'" [class.yellow]="dashboard.systemHealth.errorRate >= '1%'"></span>
              <span class="health-label">Taxa de Erro</span>
              <span class="health-val">{{ dashboard.systemHealth.errorRate }}</span>
            </div>
            <div class="health-item">
              <span class="health-dot blue"></span>
              <span class="health-label">Sessões Ativas</span>
              <span class="health-val">{{ dashboard.systemHealth.activeSessions }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== ACCOUNTS ========== -->
    <div class="content-area" *ngIf="!loading && activeSection === 'accounts'">
      <div class="section-stats">
        <span class="stat-chip">{{ pendingAccounts.length }} pendentes</span>
      </div>
      <div class="data-table">
        <div class="table-header">
          <span class="col-name">Nome</span>
          <span class="col-email">Email</span>
          <span class="col-status">KYC Status</span>
          <span class="col-risk">Risco</span>
          <span class="col-actions">Ações</span>
        </div>
        <div class="table-row" *ngFor="let a of pendingAccounts">
          <span class="col-name">
            <div class="user-avatar">{{ a.name.charAt(0) }}</div>
            <div>
              <strong>{{ a.name }}</strong>
              <small>{{ a.cpf }}</small>
            </div>
          </span>
          <span class="col-email">{{ a.email }}</span>
          <span class="col-status">
            <span class="status-chip kyc">{{ a.kycStatus }}</span>
          </span>
          <span class="col-risk">
            <div class="risk-bar">
              <div class="risk-fill" [style.width.%]="a.riskScore"
                   [class.low]="a.riskScore < 30" [class.med]="a.riskScore >= 30 && a.riskScore < 70" [class.high]="a.riskScore >= 70"></div>
            </div>
            <small>{{ a.riskScore }}%</small>
          </span>
          <span class="col-actions">
            <button class="action-btn approve" (click)="reviewAccount(a.id, true)">Aprovar</button>
            <button class="action-btn reject" (click)="reviewAccount(a.id, false)">Rejeitar</button>
          </span>
        </div>
      </div>
    </div>

    <!-- ========== FRAUD ========== -->
    <div class="content-area" *ngIf="!loading && activeSection === 'fraud'">
      <div class="section-stats">
        <span class="stat-chip red">{{ pendingFraudCount }} pendentes</span>
        <span class="stat-chip orange">{{ highSeverityCount }} alta severidade</span>
      </div>
      <div class="fraud-list">
        <div class="fraud-card" *ngFor="let a of fraudAlerts" [ngClass]="getSeverityClass(a.severity)">
          <div class="fraud-card-header">
            <div class="fraud-card-left">
              <span class="sev-badge" [ngClass]="'badge-' + a.severity">{{ getSeverityLabel(a.severity) }}</span>
              <strong>{{ a.type }}</strong>
            </div>
            <div class="fraud-card-right">
              <span class="fraud-status" [ngClass]="'fstatus-' + a.status.toLowerCase()">{{ a.status }}</span>
            </div>
          </div>
          <div class="fraud-card-body">
            <p>{{ a.description }}</p>
            <div class="fraud-meta-row">
              <span>&#128100; {{ a.accountName }}</span>
              <span *ngIf="a.amount > 0">&#128176; R$ {{ a.amount | number:'1.2-2' }}</span>
              <span>&#128336; {{ a.createdAt | date:'HH:mm' }}</span>
            </div>
          </div>
          <div class="fraud-card-actions" *ngIf="a.status === 'Pendente'">
            <button class="action-btn reject" (click)="fraudAction(a.id, 'block')">&#128683; Bloquear</button>
            <button class="action-btn approve" (click)="fraudAction(a.id, 'approve')">&#9989; Liberar</button>
            <button class="action-btn investigate" (click)="fraudAction(a.id, 'investigate')">&#128269; Investigar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== TRANSACTIONS ========== -->
    <div class="content-area" *ngIf="!loading && activeSection === 'transactions'">
      <!-- KPI CARDS -->
      <div class="kpi-grid" *ngIf="transactionsKpis">
        <div class="kpi-card">
          <div class="kpi-header"><span class="kpi-label">Total Transações</span></div>
          <div class="kpi-value">{{ transactionsKpis.totalTransactions | number }}</div>
          <div class="kpi-sub">{{ transactionsKpis.todayTransactions }} hoje</div>
        </div>
        <div class="kpi-card accent-blue">
          <div class="kpi-header"><span class="kpi-label">Volume PIX</span></div>
          <div class="kpi-value">R$ {{ transactionsKpis.pixVolume | number:'1.0-0' }}</div>
          <div class="kpi-sub">{{ transactionsKpis.weekTransactions }} esta semana</div>
        </div>
        <div class="kpi-card accent-green">
          <div class="kpi-header"><span class="kpi-label">Volume Boleto</span></div>
          <div class="kpi-value">R$ {{ transactionsKpis.boletoVolume | number:'1.0-0' }}</div>
          <div class="kpi-sub">Ticket médio: R$ {{ transactionsKpis.avgTicket | number:'1.0-0' }}</div>
        </div>
        <div class="kpi-card accent-red">
          <div class="kpi-header"><span class="kpi-label">Volume Cartão</span></div>
          <div class="kpi-value">R$ {{ transactionsKpis.cardVolume | number:'1.0-0' }}</div>
          <div class="kpi-sub">Total: R$ {{ transactionsKpis.totalVolume | number:'1.0-0' }}</div>
        </div>
      </div>

      <!-- VOLUME CHART -->
      <div class="charts-row">
        <div class="chart-card full-width">
          <div class="chart-header">
            <h3>Volume Diário (R$)</h3>
            <span class="chart-period">Últimos 14 dias</span>
          </div>
          <div class="chart-canvas-wrapper chart-tall">
            <canvas id="chartVolume"></canvas>
          </div>
        </div>
      </div>

      <!-- FILTERS -->
      <div class="tx-filters">
        <button class="tx-filter-btn" [class.active]="txFilterType === ''" (click)="filterTx('')">Todos</button>
        <button class="tx-filter-btn pix" [class.active]="txFilterType === 'PIX'" (click)="filterTx('PIX')">PIX</button>
        <button class="tx-filter-btn boleto" [class.active]="txFilterType === 'BOLETO'" (click)="filterTx('BOLETO')">Boleto</button>
        <button class="tx-filter-btn card" [class.active]="txFilterType === 'CARD'" (click)="filterTx('CARD')">Cartão</button>
      </div>

      <!-- TABLE -->
      <div class="data-table" *ngIf="transactionsData.length > 0">
        <div class="table-header tx-table-header">
          <span>Data</span>
          <span>Tipo</span>
          <span>Descrição</span>
          <span>Contraparte</span>
          <span class="col-right">Valor</span>
        </div>
        <div class="table-row tx-table-row" *ngFor="let tx of transactionsData">
          <span class="tx-date">{{ formatTxDate(tx.date) }}</span>
          <span>
            <span class="tx-type-badge" [ngClass]="'badge-' + tx.type.toLowerCase()">{{ tx.type }}</span>
          </span>
          <span class="tx-desc">{{ tx.description }}</span>
          <span class="tx-counter">{{ tx.counterpartyName || '—' }}</span>
          <span class="col-right" [class.tx-credit]="tx.isCredit" [class.tx-debit]="!tx.isCredit">
            {{ tx.isCredit ? '+' : '-' }} R$ {{ formatCurrency(tx.amount) }}
          </span>
        </div>
      </div>
      <div class="feed-empty" *ngIf="transactionsData.length === 0" style="padding: 40px; text-align: center; color: #94a3b8;">
        Nenhuma transação encontrada
      </div>

      <!-- PAGINATION -->
      <div class="tx-pagination" *ngIf="transactionsPagination && transactionsPagination.totalPages > 1">
        <button class="tx-page-btn" [disabled]="txPage <= 1" (click)="changeTxPage(-1)">&#9664;</button>
        <span class="tx-page-info">{{ txPage }} de {{ transactionsPagination.totalPages }}</span>
        <button class="tx-page-btn" [disabled]="txPage >= transactionsPagination.totalPages" (click)="changeTxPage(1)">&#9654;</button>
      </div>
    </div>

    <!-- ========== SYSTEM ========== -->
    <div class="content-area" *ngIf="!loading && activeSection === 'system'">
      <div class="services-grid">
        <div class="service-card" *ngFor="let svc of systemServices"
             [ngClass]="getServiceStatusClass(svc.status)">
          <div class="service-status">
            <span class="status-dot"></span> {{ getServiceStatusLabel(svc.status) }}
          </div>
          <h4>{{ svc.service }}</h4>
          <span class="service-detail">{{ svc.port ? 'Porta ' + svc.port + ' &#183; ' : '' }}{{ svc.detail }}</span>
        </div>
      </div>
      <div class="system-summary">
        <div class="summary-item"><span>Uptime</span><strong>{{ systemMetrics?.uptime || '-' }}</strong></div>
        <div class="summary-item"><span>Taxa de Erro</span><strong>{{ systemMetrics?.errorRate != null ? systemMetrics.errorRate + '%' : '-' }}</strong></div>
        <div class="summary-item"><span>Memória</span><strong>{{ systemMetrics?.memoryMb ? systemMetrics.memoryMb + ' MB' : '-' }}</strong></div>
        <div class="summary-item"><span>Serviços</span><strong>{{ systemServices.length }}</strong></div>
      </div>
    </div>
  </main>
</div>
