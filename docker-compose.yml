networks:
  kll-krt-network:
    external: true

services:
  gateway:
    build:
      context: .
      dockerfile: src/Services/KRT.Gateway/KRT.Gateway/Dockerfile
    container_name: krt-gateway
    ports:
      - "5000:80"
    depends_on:
      - payments-api
      - onboarding-api
    environment:
      ASPNETCORE_ENVIRONMENT: Docker
    networks:
      - kll-krt-network
    restart: unless-stopped

  payments-api:
    build:
      context: .
      dockerfile: src/Services/KRT.Payments/KRT.Payments.Api/Dockerfile
    container_name: krt-payments
    ports:
      - "5002:80"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      Services__OnboardingUrl: "http://onboarding-api:80/"
      ASPNETCORE_URLS: "http://+:80"
      ConnectionStrings__DefaultConnection: "Host=shared-postgres;Port=5432;Database=krtbank;Username=krt;Password=krt"
      Redis__ConnectionString: "shared-redis:6379,defaultDatabase=0"
      Redis__Configuration: "shared-redis:6379,defaultDatabase=0"
      RabbitMq__HostName: "shared-rabbitmq"
      RabbitMq__UserName: "guest"
      RabbitMq__Password: "guest"
      Kafka__BootstrapServers: "shared-kafka:9092"
      Keycloak__Authority: "http://shared-keycloak:8080/realms/krt-bank"
      Security__ApiKey: "${KRT_API_KEY:?Set KRT_API_KEY in .env}"
      Security__AdminApiKey: "${KRT_ADMIN_API_KEY:?Set KRT_ADMIN_API_KEY in .env}"
      Serilog__WriteTo__1__Args__serverUrl: "http://krt-seq:5341"
    networks:
      - kll-krt-network
    restart: unless-stopped

  onboarding-api:
    build:
      context: .
      dockerfile: src/Services/KRT.Onboarding/KRT.Onboarding.Api/Dockerfile
    container_name: krt-onboarding
    ports:
      - "5001:80"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: "http://+:80"
      ConnectionStrings__DefaultConnection: "Host=shared-postgres;Port=5432;Database=krtbank;Username=krt;Password=krt"
      Redis__ConnectionString: "shared-redis:6379,defaultDatabase=0"
      Redis__Configuration: "shared-redis:6379,defaultDatabase=0"
      RabbitMq__HostName: "shared-rabbitmq"
      RabbitMq__UserName: "guest"
      RabbitMq__Password: "guest"
      Kafka__BootstrapServers: "shared-kafka:9092"
      Keycloak__Authority: "http://shared-keycloak:8080/realms/krt-bank"
      Keycloak__BaseUrl: "http://shared-keycloak:8080"
      Keycloak__Realm: "krt-bank"
      Keycloak__ClientId: "krt-bank-app"
      Keycloak__AdminUser: "${KEYCLOAK_ADMIN:-admin}"
      Keycloak__AdminPassword: "${KEYCLOAK_ADMIN_PASSWORD:?Set KEYCLOAK_ADMIN_PASSWORD in .env}"
      Email__SmtpPassword: "${SMTP_PASSWORD:?Set SMTP_PASSWORD in .env}"
      Email__FromAddress: "${EMAIL_FROM_ADDRESS:?Set EMAIL_FROM_ADDRESS in .env}"
      Serilog__WriteTo__1__Args__serverUrl: "http://krt-seq:5341"
    networks:
      - kll-krt-network
    restart: unless-stopped

  web:
    build:
      context: ./src/Web/KRT.Web
      dockerfile: Dockerfile
    container_name: krt-web
    ports:
      - "4200:80"
    depends_on:
      - gateway
    networks:
      - kll-krt-network
    restart: unless-stopped

  seq:
    image: datalust/seq:2024.1
    container_name: krt-seq
    environment:
      ACCEPT_EULA: "Y"
    ports:
      - "5341:5341"
      - "8081:80"
    volumes:
      - seq-data:/data
    networks:
      - kll-krt-network
    restart: unless-stopped

volumes:
  seq-data:
